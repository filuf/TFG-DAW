---
/***************************************************
COMPONENTE TOP MENU
Autores: Agustín
Fecha: 04/06/2025
Version: 1.1
***************************************************/
import styles from "./Header.module.css";
import UserLogin from "./UserLogin";
const apiAuthUrl = import.meta.env.VITE_API_AUTH_URL;
---

<header class={styles.header}>
  <a href="/" class={styles.logoContainer}>
    <img src="/favicon.png" alt="Logo cafetería" class={styles.logoImg} />
    <span class={styles.title}>Cafetería Ventura Rodríguez</span>
  <a/>

  <!-- Botón hamburguesa -->
  <button class={styles.hamburger} id="hamburgerBtn" aria-label="Abrir menú" aria-controls="mobileNav" aria-expanded="false">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect y="7" width="32" height="3" rx="1.5" fill="#412722" class="bar bar1" />
      <rect y="15" width="32" height="3" rx="1.5" fill="#412722" class="bar bar2" />
      <rect y="23" width="32" height="3" rx="1.5" fill="#412722" class="bar bar3" />
    </svg>
  </button>
  <!-- Componente de login compartido -->
  <div class={styles.authContainer} id="sharedAuthContainer">
    <UserLogin apiAuthUrl={apiAuthUrl} client:only="react" />
  </div>

  <!-- Menú normal (escritorio) -->
  <nav class={styles.nav} id="mainNav">
    <a href="/" class={styles.navLink}>Inicio</a>
    <a href="/cart" class={styles.navLink} id="cartLink">Carrito</a>
    <a href="/orders" class={styles.navLink} id="ordersLink">Pedidos</a>
  </nav>
  
  <!-- Menú móvil (sidebar) -->
  <nav class={styles.mobileNav} id="mobileNav" aria-hidden="true">
    <div class={styles.mobileNavHeader}>
      <button class={styles.closeBtn} id="closeMobileNav" aria-label="Cerrar menú">×</button>
      <h2 class={styles.mobileNavTitle}>Menú</h2>
    </div>
    <ul class={styles.mobileNavList}>
      <li><a href="/" class={styles.mobileNavLink}>
        <span class={styles.mobileNavIcon}>🏠</span>
        Inicio
      </a></li>
      <li id="mobileCartItem" style="display: none;">
        <a href="/cart" class={styles.mobileNavLink}>
          <span class={styles.mobileNavIcon}>🛒</span>
          Carrito
        </a>
      </li>
      <li id="mobileOrdersItem" style="display: none;">
        <a href="/orders" class={styles.mobileNavLink}>
          <span class={styles.mobileNavIcon}>📋</span>
          Pedidos
        </a>
      </li>
      <li class={styles.mobileNavDivider}></li>
      <li id="mobileAuthItem">
        <!-- Componente de autenticación específico para móvil -->
        <UserLogin apiAuthUrl={apiAuthUrl} client:only="react" />
      </li>
    </ul>
  </nav>
  <div class={styles.overlay} id="navOverlay"></div>
</header>

<script>
  // Script para controlar la visibilidad del carrito basado en la autenticación
  function updateCartVisibility() {
    const cartLink = document.getElementById('cartLink');
    const ordersLink = document.getElementById('ordersLink');
    const mobileCartItem = document.getElementById('mobileCartItem');
    const mobileOrdersItem = document.getElementById('mobileOrdersItem');
    const isLoggedIn = sessionStorage.getItem('token') !== null;
    
    if (cartLink) cartLink.style.display = isLoggedIn ? 'block' : 'none';
    if (ordersLink) ordersLink.style.display = isLoggedIn ? 'block' : 'none';
    if (mobileCartItem) mobileCartItem.style.display = isLoggedIn ? 'block' : 'none';
    if (mobileOrdersItem) mobileOrdersItem.style.display = isLoggedIn ? 'block' : 'none';
  }

  // Función para mover el componente de autenticación al menú móvil
  function updateMobileAuth() {
    // Ya no necesitamos mover el componente dinámicamente
    // porque ahora tenemos un componente UserLogin específico para móvil
    console.log('updateMobileAuth: Componente móvil ya está en su lugar');
  }

  // Script del menú móvil
  document.addEventListener('DOMContentLoaded', () => {
    // Verificar tamaño de pantalla
    console.log('Tamaño de pantalla:', window.innerWidth, 'x', window.innerHeight);
    console.log('¿Es móvil?', window.innerWidth <= 700);
    
    // Obtener elementos del DOM
    const elements = {
      hamburgerBtn: document.getElementById('hamburgerBtn'),
      mobileNav: document.getElementById('mobileNav'),
      closeBtn: document.getElementById('closeMobileNav'),
      overlay: document.getElementById('navOverlay')
    };

    // Verificar que todos los elementos existen
    const missingElements = Object.entries(elements)
      .filter(([_, element]) => !element)
      .map(([name]) => name);

    if (missingElements.length > 0) {
      console.error('Elementos faltantes para el menú móvil:', missingElements.join(', '));
      return;
    }

    // Verificar visibilidad del botón hamburguesa
    const hamburgerBtnElement = elements.hamburgerBtn;
    if (hamburgerBtnElement) {
      console.log('Estado del botón hamburguesa:', {
        display: window.getComputedStyle(hamburgerBtnElement).display,
        visibility: window.getComputedStyle(hamburgerBtnElement).visibility,
        classes: hamburgerBtnElement.className
      });
    }

    const { hamburgerBtn, mobileNav, closeBtn, overlay } = elements;

    function openMobileNav() {
      if (!mobileNav || !hamburgerBtn || !overlay) return;
      
      console.log('Abriendo menú móvil'); // Debug
      console.log('Estado inicial del menú:', {
        display: window.getComputedStyle(mobileNav).display,
        right: window.getComputedStyle(mobileNav).right,
        classes: mobileNav.className
      });
      
      // Actualizar atributos ARIA
      mobileNav.setAttribute('aria-hidden', 'false');
      hamburgerBtn.setAttribute('aria-expanded', 'true');
      
      // Mostrar overlay
      overlay.style.display = 'block';
      
      // Forzar un reflow para asegurar que la animación funcione
      void mobileNav.offsetWidth;
      
      // Añadir clases para la animación
      mobileNav.classList.add('open');
      overlay.classList.add('show');
      
      // Forzar visibilidad con estilos inline como respaldo
      mobileNav.style.display = 'block';
      mobileNav.style.right = '0';
      mobileNav.style.visibility = 'visible';
      mobileNav.style.opacity = '1';
      
      console.log('Estado después de abrir:', {
        display: window.getComputedStyle(mobileNav).display,
        right: window.getComputedStyle(mobileNav).right,
        classes: mobileNav.className
      });
      
      // Actualizar la posición del componente de auth
      updateMobileAuth();
    }

    function closeMobileNav() {
      if (!mobileNav || !hamburgerBtn || !overlay) return;
      
      console.log('Cerrando menú móvil'); // Debug
      
      // Actualizar atributos ARIA
      mobileNav.setAttribute('aria-hidden', 'true');
      hamburgerBtn.setAttribute('aria-expanded', 'false');
      
      // Remover clases para la animación
      mobileNav.classList.remove('open');
      overlay.classList.remove('show');
      
      // Limpiar estilos inline
      mobileNav.style.display = '';
      mobileNav.style.right = '';
      mobileNav.style.visibility = '';
      mobileNav.style.opacity = '';
      
      // Ocultar overlay después de la animación
      setTimeout(() => { 
        if (overlay) overlay.style.display = 'none';
        updateMobileAuth();
      }, 300);
    }

    // Añadir event listeners con prevención de eventos por defecto
    hamburgerBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Botón hamburguesa clickeado'); // Debug
      openMobileNav();
    });
    
    closeBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      closeMobileNav();
    });
    
    overlay?.addEventListener('click', (e) => {
      e.preventDefault();
      closeMobileNav();
    });

    // Actualizar al cargar la página
    updateCartVisibility();
    updateMobileAuth();
  });

  // Actualizar al cambiar el tamaño de la ventana
  window.addEventListener('resize', updateMobileAuth);

  // Escuchar cambios en el sessionStorage
  window.addEventListener('storage', (e) => {
    if (e.key === 'token') {
      updateCartVisibility();
    }
  });

  // Escuchar eventos personalizados para login/logout
  window.addEventListener('user-logout', updateCartVisibility);
  window.addEventListener('user-login', updateCartVisibility);

  // Escuchar evento de navegación de Astro
  document.addEventListener('astro:after-swap', () => {
    updateCartVisibility();
    updateMobileAuth();
  });
</script> 